<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FMCSA ‚Äì Reasonable Suspicion Training</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="../css/main.css" />
<style>
.quiz-container { max-width: 800px; margin: auto; }
.question { margin-bottom: 25px; }
.answers label { display: block; margin-bottom: 8px; cursor: pointer; }
.quiz-nav { display:flex; justify-content:space-between; margin-top:20px; }
.hidden { display:none; }
.progress-text { font-weight:600; margin-bottom:15px; }
.result-box { padding:15px; margin-top:15px; border-radius:6px; }
.pass { background:#e6f4ea; color:#1e7e34; }
.fail { background:#fdecea; color:#c82333; }
</style>
</head>

<body>

<!-- üîê ROUTE SECURITY GUARD -->
<script>
(function () {

  const user = JSON.parse(localStorage.getItem("amsUser") || "null");

  if (!user) {
    window.location.replace("../login.html");
    return;
  }

  if (user.role === "employee") {
    alert("Unauthorized access.");
    window.location.replace("../dashboard.html");
    return;
  }

  if (localStorage.getItem("paid_fmcsa") !== "true") {
    alert("FMCSA Training requires purchase.");
    window.location.replace("../dashboard.html");
    return;
  }

  const start = localStorage.getItem("fmcsa_start_date");

  if (start) {
    const DAY_MS = 86400000;
    const LIMIT_DAYS = 30;

    const elapsed = Date.now() - Number(start);
    const daysUsed = Math.floor(elapsed / DAY_MS);

    if (daysUsed >= LIMIT_DAYS) {
      alert("FMCSA training window expired. Repurchase required.");
      window.location.replace("../dashboard.html");
      return;
    }
  }

})();
</script>

<main class="module-container">

<header class="module-header">
<h1>Supervisor Reasonable Suspicion Awareness Training</h1>
<button class="btn-secondary" onclick="window.location.href='dashboard.html'">
Back to Dashboard
</button>
</header>

<section class="module-section">
<p>
This training must be completed within <strong>30 days</strong> of purchase.
You must review all content before taking the quiz.
</p>
</section>

<section class="module-section" id="contentSection">
<h2>Training Content</h2>

<div class="pdf-viewer">
<canvas id="pdfCanvas"></canvas>

<div class="pdf-controls">
<button id="prevPageBtn" class="btn-secondary">‚Üê Previous</button>
<span>Page <span id="currentPage">1</span> of <span id="totalPages">--</span></span>
<button id="nextPageBtn" class="btn-secondary">Next ‚Üí</button>
</div>

<div class="progress-wrapper">
<div id="progressBar"></div>
</div>
</div>

<button id="completeBtn" class="btn-primary">
I Have Completed the Training Content
</button>

</section>

<section class="module-section hidden" id="quizSection">
<h2>Module A Quiz</h2>

<div class="quiz-container">
<div class="progress-text" id="pageIndicator"></div>
<div id="quizQuestions"></div>

<div class="quiz-nav">
<button id="prevQuizBtn" class="btn-secondary">Previous</button>
<button id="nextQuizBtn" class="btn-primary">Next</button>
</div>

<div id="quizResult"></div>
</div>
</section>

</main>

<!-- PDF.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ==========================
RESTORE PROGRESS
========================== */
document.addEventListener("DOMContentLoaded", function() {

  const contentDone = localStorage.getItem("fmcsa_mod1_content_done");

  if (contentDone === "true") {
    document.getElementById("contentSection").classList.add("hidden");
    document.getElementById("quizSection").classList.remove("hidden");
    initQuiz();
  }

});

/* ==========================
PDF VIEWER
========================== */
const url = "../assets/fmcsa/1-Sup-Reas-Susp-Training.pdf";
let pdfDoc = null;
let pageNum = 1;
let totalPages = 0;

const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");
const completeBtn = document.getElementById("completeBtn");
completeBtn.disabled = true;

pdfjsLib.getDocument(url).promise.then(pdf => {
  pdfDoc = pdf;
  totalPages = pdf.numPages;
  document.getElementById("totalPages").textContent = totalPages;
  renderPage(pageNum);
});

function renderPage(num) {
  pdfDoc.getPage(num).then(page => {
    const viewport = page.getViewport({ scale: 1 });

    canvas.height = viewport.height;
    canvas.width = viewport.width;

    page.render({
      canvasContext: ctx,
      viewport: viewport
    });

    document.getElementById("currentPage").textContent = num;
    document.getElementById("progressBar").style.width =
      (num / totalPages * 100) + "%";

    completeBtn.disabled = (num !== totalPages);
  });
}

document.getElementById("prevPageBtn").onclick = () => {
  if (pageNum > 1) {
    pageNum--;
    renderPage(pageNum);
  }
};

document.getElementById("nextPageBtn").onclick = () => {
  if (pageNum < totalPages) {
    pageNum++;
    renderPage(pageNum);
  }
};

completeBtn.onclick = () => {
  localStorage.setItem("fmcsa_mod1_content_done", "true");

  document.getElementById("contentSection").classList.add("hidden");
  document.getElementById("quizSection").classList.remove("hidden");

  initQuiz();
};
  
/* ==========================
PDF VIEWER
========================== */
const url = "../assets/fmcsa/1-Sup-Reas-Susp-Training.pdf";
let pdfDoc=null,pageNum=1,totalPages=0;
const canvas=document.getElementById("pdfCanvas");
const ctx=canvas.getContext("2d");
const completeBtn=document.getElementById("completeBtn");
completeBtn.disabled=true;

pdfjsLib.getDocument(url).promise.then(pdf=>{
pdfDoc=pdf;
totalPages=pdf.numPages;
document.getElementById("totalPages").textContent=totalPages;
renderPage(pageNum);
});

function renderPage(num){
pdfDoc.getPage(num).then(page=>{
const viewport=page.getViewport({scale:1});
canvas.height=viewport.height;
canvas.width=viewport.width;
page.render({canvasContext:ctx,viewport});
document.getElementById("currentPage").textContent=num;
document.getElementById("progressBar").style.width=(num/totalPages*100)+"%";
completeBtn.disabled=(num!==totalPages);
});
}

document.getElementById("prevPageBtn").onclick=()=>{if(pageNum>1){pageNum--;renderPage(pageNum);}};
document.getElementById("nextPageBtn").onclick=()=>{if(pageNum<totalPages){pageNum++;renderPage(pageNum);}};

completeBtn.onclick=()=>{
localStorage.setItem("fmcsa_mod1_content_done","true");
document.getElementById("contentSection").classList.add("hidden");
document.getElementById("quizSection").classList.remove("hidden");
initQuiz();
};

/* ==========================
QUIZ ENGINE
========================== */

const PASS_SCORE = 7;
const MAX_ATTEMPTS = 3;
const COOLDOWN_MINUTES = 15;
const ATTEMPT_KEY = "fmcsa_mod1_attempts";
const COOLDOWN_KEY = "fmcsa_mod1_cooldown";
const PROGRESS_KEY = "fmcsa_mod1_quiz_progress";  

const questions = [

{
q: "A Drug-Free Workplace policy does which of the following?",
a: {
  A: "Promote a safe work environment",
  B: "Maintain product integrity",
  C: "Encourage employees who have a substance abuse problem to voluntarily seek help",
  D: "All of the above"
},
correct: "D"
},

{
q: "Which off the following is NOT a category of substance abuse symptom or warning signs?",
a: { A:"Behavioral", B:"Physical", C:"Clinical", D:"Performance" },
correct: "C"
},

{
q: "Workplace aggression, Employee burnout, Anxiety, Depression, Paranoia, Withdrawn, Denial, and over sensitivity would be examples of which warning signs?",
a: { A:"Emotional", B:"Behavioral", C:"Physical", D:"Performance" },
correct: "A"
},

{
q: "Which of the following would be a valid reason for a supervisor to be worried about an employee?",
a: { A:"Habitual lateness", B:"Declining attention to personal hygiene", C:"Workplace aggression", D:"All of the above" },
correct: "D"
},

{
q: "Which of the following would NOT be considered a ‚Äúdirect personal action‚Äùwarning sign?",
a: { A:"Falling asleep on the job", B:"DWI conviction", C:"Unexplained increase in disputes with fellow workers", D:"Borrowing money from fellow employees" },
correct: "A"
},

{
q: "Enabling refers to allowing a substance abuser to avoid the consequences of his/her actions. Which of the following actions by a supervisor is the most correct answer for enabling?",
a: { A:"Sending an employee home sick", B:"Covering up for a poor or declining job performance", C:"Transferring the employee to another department", D:"All of these are considered enabling actions" },
correct: "D"
},

{
q: "Which of the following does NOT relate to documentation?",
a: { A:"It is an essential ingredient in any drug-free workplace program.", B:"It allows the supervisor to have their Human Resource department handle the problem first.", C:"It allows for declining performance to be recorded", D:"May be used to address employee issues" },
correct: "B"
},

{
q: "Sometimes as a supervisor you may face a crisis situation when an employee appears to be under the influence of alcohol and/or drugs. Which of the following should you do?",
a: { A:"Immediately confront the employee and ask him/her if they have been drinking or taking drugs", B:"Enlist the assistance of a fellow manager to observe the employee‚Äôs actions", C:"Call your Human Resources department and let them handle the problem", D:"Tell the employee to go home" },
correct: "B"
}

];

let currentPage = 0;
let userAnswers = new Array(questions.length).fill(null);
  
function initQuiz(){

  // üîÅ Restore saved progress
  const saved = localStorage.getItem(PROGRESS_KEY);
  if(saved){
    const data = JSON.parse(saved);
    currentPage = data.currentPage ?? 0;
    userAnswers = data.userAnswers ?? userAnswers;
  }

  updateQuizPage();
}

function updateQuizPage(){
const start=currentPage*2;
const end=start+2;
const container=document.getElementById("quizQuestions");
container.innerHTML="";
document.getElementById("pageIndicator").textContent=
`Page ${currentPage+1} of 4`;

for(let i=start;i<end;i++){
const q=questions[i];
const div=document.createElement("div");
div.className="question";
div.innerHTML=`<strong>${i+1}. ${q.q}</strong>`;
const ansDiv=document.createElement("div");
ansDiv.className="answers";

Object.entries(q.a).forEach(([letter,text])=>{
ansDiv.innerHTML+=`
<label>
<input type="radio" name="q${i}" value="${letter}"
${userAnswers[i]===letter?"checked":""}>
${letter}) ${text}
</label>`;
});

div.appendChild(ansDiv);
container.appendChild(div);
}
}

document.getElementById("nextQuizBtn").onclick=()=>{
  saveAnswers();

  if(currentPage < 3){
    currentPage++;
    updateQuizPage();
  }
  else{
    gradeQuiz();
  }
};
document.getElementById("prevQuizBtn").onclick=()=>{
  saveAnswers();
  if(currentPage > 0){
    currentPage--;
    updateQuizPage();
  }
};
  
function saveAnswers(){
  const inputs=document.querySelectorAll("#quizQuestions input");
  inputs.forEach(input=>{
    if(input.checked){
      const qIndex=parseInt(input.name.replace("q",""));
      userAnswers[qIndex]=input.value;
    }
  });

  // üîê SAVE QUIZ STATE
  localStorage.setItem(PROGRESS_KEY, JSON.stringify({
    currentPage,
    userAnswers
  }));
}
  
/* üîÅ AUTO-SAVE WHEN USER CLICKS AN ANSWER */
document.addEventListener("change", function(e){
  if(e.target.matches("#quizQuestions input[type='radio']")){
    saveAnswers();
  }
});;

function gradeQuiz(){

const cooldownUntil=localStorage.getItem(COOLDOWN_KEY);
if(cooldownUntil && Date.now()<cooldownUntil){
alert("Cooldown active. Try again later.");
return;
}

let score=0;
questions.forEach((q,i)=>{
if(userAnswers[i]===q.correct) score++;
});

let attempts=parseInt(localStorage.getItem(ATTEMPT_KEY))||0;

if (score >= PASS_SCORE) {

  localStorage.setItem("fmcsaModuleACompleted", "true");

  // üî• Generate Certificate ID
  let certId = localStorage.getItem("fmcsaModuleACertificateId");

  if (!certId) {
    certId = "AMS-A-" + Date.now().toString().slice(-8);
    localStorage.setItem("fmcsaModuleACertificateId", certId);
  }

  // üî• Store Completion Date (IMPORTANT)
  localStorage.setItem("fmcsaModuleADate", Date.now());

  localStorage.removeItem(ATTEMPT_KEY);
  localStorage.removeItem(PROGRESS_KEY);

  document.getElementById("quizResult").innerHTML =
  `<div class="result-box pass">
    You passed! Generating Certificate...
  </div>`;

  setTimeout(()=>{
    window.location.href="fmcsa-certificates.html";
  },2000);

}
  
else{
attempts++;
localStorage.setItem(ATTEMPT_KEY,attempts);
const remaining=MAX_ATTEMPTS-attempts;

if(remaining<=0){
localStorage.setItem(COOLDOWN_KEY,Date.now()+COOLDOWN_MINUTES*60000);
localStorage.setItem(ATTEMPT_KEY,0);
}

document.getElementById("quizResult").innerHTML=
`<div class="result-box fail">
You scored ${score}/8.<br>
Attempts remaining: ${remaining>0?remaining:0}
</div>`;
}
}
</script>

</body>
</html>
