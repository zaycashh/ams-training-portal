<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FMCSA – Reasonable Suspicion Training</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/main.css" />
</head>
<body>

<main class="module-container">

  <!-- HEADER -->
  <header class="module-header">
    <h1>Supervisor Reasonable Suspicion Awareness Training</h1>
    <button class="btn-secondary" onclick="goBack()">Back to Dashboard</button>
  </header>

  <!-- INFO -->
  <section class="module-section">
    <p>
      This training must be completed within <strong>30 days</strong> of purchase.
      You must review all content before taking the quiz.
    </p>
  </section>

  <!-- CONTENT SECTION -->
  <section class="module-section" id="contentSection">
    <h2>Training Content</h2>

    <div class="pdf-viewer">

      <canvas id="pdfCanvas"></canvas>

      <div class="pdf-controls">
        <button id="prevPageBtn" class="btn-secondary">← Previous</button>

        <span>
          Page <span id="currentPage">1</span> of
          <span id="totalPages">--</span>
        </span>

        <button id="nextPageBtn" class="btn-secondary">Next →</button>
      </div>

      <div class="progress-wrapper">
        <div id="progressBar"></div>
      </div>

    </div>

    <button class="btn-primary" onclick="markContentComplete()">
      I Have Completed the Training Content
    </button>
  </section>

  <!-- QUIZ LOCKED -->
  <section class="module-section hidden" id="quizUnlockSection">
    <h2>Quiz Unlocked</h2>
    <p>You may now begin the quiz. A score of <strong>80%</strong> is required to pass.</p>

    <button class="btn-primary" onclick="startQuiz()">
      Start Quiz
    </button>
  </section>

</main>

<!-- ✅ PDF.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>

/* ==========================
   AUTH + PAYMENT GUARD
========================== */
(function () {

  const user = localStorage.getItem("amsUser");
  if (!user) {
    window.location.replace("../login.html");
    return;
  }

  if (localStorage.getItem("paid_fmcsa") !== "true") {
    alert("FMCSA training is locked. Please purchase from dashboard.");
    window.location.replace("../dashboard.html");
    return;
  }

  const startDate = localStorage.getItem("fmcsa_start_date");
  if (!startDate) {
    window.location.replace("../dashboard.html");
    return;
  }

  const DAY_MS = 86400000;
  const LIMIT_DAYS = 30;

  if ((Date.now() - Number(startDate)) > LIMIT_DAYS * DAY_MS) {
    alert("Your 30-day training window has expired.");
    localStorage.removeItem("paid_fmcsa");
    window.location.replace("../dashboard.html");
    return;
  }

  // Restore quiz unlock
  if (localStorage.getItem("fmcsa_mod1_content_done") === "true") {
    document.getElementById("quizUnlockSection")
      .classList.remove("hidden");
  }

})();

/* ===========================
   NAVIGATION
=========================== */
function goBack() {
  window.location.href = "../dashboard.html";
}

/* ===========================
   PDF SLIDE VIEWER ENGINE
=========================== */

const url = "../assets/fmcsa/1-Sup-Reas-Susp-Training.pdf";

let pdfDoc = null;
let pageNum = 1;
let totalPages = 0;

const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");

pdfjsLib.getDocument(url).promise.then(pdf => {
  pdfDoc = pdf;
  totalPages = pdf.numPages;
  document.getElementById("totalPages").textContent = totalPages;
  renderPage(pageNum);
});

function renderPage(num) {
  pdfDoc.getPage(num).then(page => {
    const viewport = page.getViewport({ scale: 1.4 });
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    page.render({
      canvasContext: ctx,
      viewport: viewport
    });

    document.getElementById("currentPage").textContent = num;

    const percent = (num / totalPages) * 100;
    document.getElementById("progressBar").style.width = percent + "%";
  });
}

document.getElementById("prevPageBtn").addEventListener("click", () => {
  if (pageNum <= 1) return;
  pageNum--;
  renderPage(pageNum);
});

document.getElementById("nextPageBtn").addEventListener("click", () => {
  if (pageNum >= totalPages) return;
  pageNum++;
  renderPage(pageNum);
});

/* ===========================
   CONTENT COMPLETION
=========================== */
function markContentComplete() {

  localStorage.setItem("fmcsa_mod1_content_done", "true");

  document.getElementById("quizUnlockSection")
    .classList.remove("hidden");

  alert("Content marked complete. You may now begin the quiz.");
}

/* ===========================
   QUIZ SETTINGS
=========================== */

const PASS_PERCENTAGE = 80;
const MAX_ATTEMPTS = 3;
const COOLDOWN_MINUTES = 15;

const QUIZ_ATTEMPTS_KEY = "fmcsa_mod1_attempts";
const QUIZ_COOLDOWN_KEY = "fmcsa_mod1_cooldown_until";
const QUIZ_PASSED_KEY = "fmcsa_mod1_quiz_passed";

function startQuiz() {

  const now = Date.now();
  const cooldownUntil = Number(localStorage.getItem(QUIZ_COOLDOWN_KEY));

  if (cooldownUntil && now < cooldownUntil) {
    const minutesLeft = Math.ceil((cooldownUntil - now) / 60000);
    alert(`You must wait ${minutesLeft} minute(s) before retrying.`);
    return;
  }

  let attempts = Number(localStorage.getItem(QUIZ_ATTEMPTS_KEY)) || 0;

  if (attempts >= MAX_ATTEMPTS) {
    alert("Maximum attempts reached. Please wait 15 minutes.");
    return;
  }

  const score = prompt("Enter simulated quiz score (0–100):");
  if (score === null) return;

  const percentage = Number(score);

  if (percentage >= PASS_PERCENTAGE) {

    localStorage.setItem(QUIZ_PASSED_KEY, "true");
    localStorage.setItem("fmcsaModuleACompleted", "true");

    alert("Quiz passed! Module A completed.");
    window.location.href = "dashboard.html";

  } else {

    attempts++;
    localStorage.setItem(QUIZ_ATTEMPTS_KEY, attempts);

    alert(`You scored ${percentage}%. Attempt ${attempts} of ${MAX_ATTEMPTS}.`);

    if (attempts >= MAX_ATTEMPTS) {
      const cooldownTime = now + COOLDOWN_MINUTES * 60000;
      localStorage.setItem(QUIZ_COOLDOWN_KEY, cooldownTime);
    }
  }
}

</script>

</body>
</html>
